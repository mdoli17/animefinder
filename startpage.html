<html>
    <style>
        #searchfield {
            text-align: center;
            position: fixed;
            top: 0;
            width: 100%;
            display: block;
            transition: top 0.3s;
        }   

        .input 
        {
            border-radius: 3ch;
            border-style:solid;
            width: 50%;
            height: 5%;
            text-align: center;
            font-size: 2ch;
        }

        ::-webkit-input-placeholder
        {
            text-align: center;
            font-size: 125%;
        }

        body {
            background: url(background.jpg) no-repeat center center fixed;
        }

        .wrapper
        {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            overflow-y: scroll;
        }
        .container {
            background-color: green;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .box {
            margin: 1%;
            display: flex;
            /* justify-content: center; */
        }

        .box img {
            display: block;
            width: 15%;
        }


        .attributeBox 
        {
            border-radius: 3ch;
            border-width: 1px;
            border-style: solid;
            background-color: thistle;
            display: flex;
            justify-content: center;
        }

        .attributeBoxXButton
        {
            border-style: none;
            background-color: transparent;
        }

        #characterattributes {
            display: flex;
            justify-content: flex-start;
        }


    </style>


    <head>
        <title>Find your character</title>
    </head>
    
    <body>
        <script>
            const HomeURL = "https://ghibliapi.herokuapp.com/people";
            const characterFolder = "Images/Characters/";
            var characterAttributes;
            
            function capitalize(str)
            {
                return str.charAt(0).toUpperCase() + str.slice(1);
            }


            function constructor()
            {
                characterAttributes = new CharacterAttributes();
            }
            
            window.onload = constructor();

            function CharacterAttributes()
            {
                this.name = null;
                this.age = null;
                this.eyecolor = null;
                this.haircolor = null;
                this.specie = null;
                this.gender = null;
            }

            let eyeColors = ["Black", "Blue", "Brown", "Grey", "Green", "Hazel", "Red", "White", "Yellow", "Emerald"];
            let hairColors = ["Black", "Blonde", "Brown", "Grey", "White", "Light", "Orange", "Beige"];

            /*
                Called when user enters something in search field
                Should get the input and call a parser for it
                Clear the search field
            */
            function onSearchEntered()
            {
                var input = document.getElementById("userinput").value;
                document.getElementById("userinput").value = "";
                parseInput(input);
            }   

            /*
                Should parse the given text
                Text can be given in any format
                
                Successful parsing cases:
                    The last word is a Character attribute and the words before are adjactives
                    Number + "Years old"
                    Specie type e.g: "God", "Human", "Cat" ... 
                    Gender
                    Name
                
                Fill in CharacterAttributes struct with given parsed input
            */
            function parseInput(text) 
            {
                var words = text.toLowerCase().split(" ");
                
                console.log(words);
                var last = words[words.length - 1];
                
                if(last == "eyes")
                {
                    var eyecolor;
                    for(var i = 0; i < words.length - 1; i++)
                    {
                        var color = capitalize(words[i]);
                        if (eyeColors.includes(color))
                        {
                            eyecolor = color;
                            break;
                        }
                    }
                    
                    characterAttributes.eyecolor = eyecolor;
                    addCharacterAttributeToUI("Eye Color");

                    console.log("The user is trying to add an EYE attribute");
                }
                else if(last == "hair")
                {
                    var haircolor = capitalize(words[0]);
                    characterAttributes.haircolor = haircolor;
                    addCharacterAttributeToUI("haircolor");
                    console.log("The user is trying to add an HAIR attribute");
                }      
                else if(words[0] == "male" || words[0] == "female"){
                    characterAttributes.gender = capitalize(words[0]);
                    addCharacterAttributeToUI("gender");
                }
                
            }

            function addCharacterAttributeToUI(attribute)
            {
                var attributeDiv = document.createElement("div");
                attributeDiv.setAttribute("class", "attributeBox");

                var label = document.createElement("label");
                label.innerHTML = attribute;

                var xButton = document.createElement("button");
                xButton.setAttribute("class", "attributeBoxXButton");
                xButton.innerHTML = "x";
                xButton.addEventListener('click', function(){
                    switch (attribute) {
                        case "Eye Color":
                            console.log("Going To Remove EyeColour");
                            characterAttributes.eyecolor = null;
                            break;
                    
                        case "haircolor":
                            characterAttributes.haircolor = null;
                            break;
                        case "gender":
                            characterAttributes.gender = null;
                            break;
                    }
                    document.getElementById("characterattributes").removeChild(attributeDiv);
                });
                attributeDiv.appendChild(label);
                attributeDiv.appendChild(xButton);

                
                document.getElementById("characterattributes").appendChild(attributeDiv);
            }

            /*
                Gets JSON data according to the CharacterAttributes
            */
            function onFindPressed() 
            {
                var data = getJSONData();
                var newData = [];
                data.then((value) => {
                    value.forEach(element => {
                        if((element.eye_color == characterAttributes.eyecolor || characterAttributes.eyecolor == null)
                        && (element.hair_color == characterAttributes.haircolor || characterAttributes.haircolor == null)
                        /*&& !(characterAttributes.eyecolor == null && characterAttributes.haircolor == null)*/)
                        {
                            newData.push(element);
                        }    
                    });
                    updateUI(newData);
                });

            }
            /*
            eyecolor = Black        eye_color = Black
            haircolor = null        hair_color = Black
           */ 

            // Updates the Scrollable Div with Data
            function updateUI(dataArray)
            {
                document.getElementById("container").textContent = " ";
                
                var count = dataArray.length;
                console.log(count);
                for(var i = 0; i < count; i++)
                {
                    var imgBox = document.createElement("div");
                    imgBox.setAttribute("class", "box");

                    var imgelem = new Image();
                    imgelem.src = characterFolder + dataArray[i].name + ".png";
                    imgelem.setAttribute("onerror", "this.src='testimage.png'");
                    imgelem.setAttribute("class", "characterImages");
                    
                    imgBox.appendChild(imgelem);
                    document.getElementById("container").appendChild(imgBox);
                }
            }
            

            async function getJSONData()
            {
                const response = await fetch(HomeURL, {mode: "cors"});
                const data = await response.json();
                return data;
            }

            function getNames() {
                var data = getJSONData();
                data.then((element) => {
                    element.forEach(value => {
                        console.log(value.name);
                    });
                });
            }



            var prevScrollpos = document.getElementById("wrapper").scrollTop;
            function printer()
            {
                var currentScrollPos = document.getElementById("wrapper").scrollTop;
                if (prevScrollpos > currentScrollPos) {
                    document.getElementById("searchfield").style.top = "0";
                } else {
                    document.getElementById("searchfield").style.top = "-50px";
                }
                prevScrollpos = currentScrollPos;
            }

        </script>

        <div class="searchfield" id="searchfield">
            <input class="input" type="text" placeholder="Enter character traits" id="userinput" onchange="onSearchEntered()">
            <button onclick="onFindPressed()">Find</button>
            <button onclick="getNames()">Get Names</button>
        </div>

        <div id="characterattributes">

        </div>

        <div id=wrapper class="wrapper" onscroll="printer()">
            <div id=container class="container">

            </div>
        </div>
    </body>
</html>